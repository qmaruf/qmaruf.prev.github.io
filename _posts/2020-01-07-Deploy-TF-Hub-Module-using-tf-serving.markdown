I am working on pet project to compare text similarity. As a goto methold, I want to get an embedding 
corresponding to each provided text. In the next step, I will calculate the similarity between these embedding to find most
similar texts to a provided one.

Let's use universal encoder from tensorflow hub to extract embedddings for each text. As I want to deploy the service 
on the cloud, I will use tf serving to serve the model. I've used the following code to serve the model using docker. I'll 
explore later how to deploy on the cloud.

```
import tensorflow.compat.v1 as tf
tf.disable_v2_behavior() 
import tensorflow_hub as hub


export_dir = "./universal_encoder/00000001"
with tf.Session(graph=tf.Graph()) as sess:
    module = hub.Module("https://tfhub.dev/google/universal-sentence-encoder/2") 
    input_params = module.get_input_info_dict()
    text_input = tf.placeholder(name='text', 
        dtype=input_params['text'].dtype, 
        shape=input_params['text'].get_shape())
    sess.run([tf.global_variables_initializer(), tf.tables_initializer()])
    embeddings = module(text_input)
    tf.saved_model.simple_save(sess, 
        export_dir, 
        inputs={'text': text_input}, 
        outputs={'embeddings': embeddings}, 
        legacy_init_op=tf.tables_initializer())
```

This code block is adapted from https://stackoverflow.com/questions/50788080/how-to-make-the-tensorflow-hub-embeddings-servable-using-tensorflow-serving
It will export the hub module into `./universal_encoder` directory using version `1`.

To serve the model using docker install docker first and pull tensorflow serving image using the following command.
```
docker pull tensorflow/serving  
docker run -p 8501:8501 -v absolute_path_to/universal_encoder:/models/universal_encoder -e MODEL_NAME=universal_encoder -t tensorflow/serving
```
At this point, the tf embedding module will be up and running. We can use `curl` to check the response the module. Use the following 
command in the terminal.

```
curl http://localhost:8501/v1/models/universal_encoder
```
The response should be something like this.
```
{
 "model_version_status": [
  {
   "version": "1",
   "state": "AVAILABLE",
   "status": {
    "error_code": "OK",
    "error_message": ""
   }
  }
 ]
}
```

Yeeee. It's working. We can check the model meta data using
```
curl http://localhost:8501/v1/models/universal_encoder/metadata
```

Output
```
{
"model_spec":{
 "name": "universal_encoder",
 "signature_name": "",
 "version": "1"
}
,
"metadata": {"signature_def": {
 "signature_def": {
  "serving_default": {
   "inputs": {
    "text": {
     "dtype": "DT_STRING",
     "tensor_shape": {
      "dim": [
       {
        "size": "-1",
        "name": ""
       }
      ],
      "unknown_rank": false
     },
     "name": "text:0"
    }
   },
   "outputs": {
    "embeddings": {
     "dtype": "DT_FLOAT",
     "tensor_shape": {
      "dim": [
       {
        "size": "-1",
        "name": ""
       },
       {
        "size": "512",
        "name": ""
       }
      ],
      "unknown_rank": false
     },
     "name": "module_apply_default/Encoder_en/hidden_layers/l2_normalize:0"
    }
   },
   "method_name": "tensorflow/serving/predict"
  }
 }
}
}
}
```

Seems like we can use the `inputs` endpoint to send request to the model. It will send the response using `output`. Let's try 
the following command.
```
curl -d '{"inputs": ["hello world"]}' -X POST http://localhost:8501/v1/models/universal_encoder:predict
```
We are asking the model to send embeddings for the text `hello world`. The response is
```
{
    "outputs": [
        [
            -0.037585672,
            -0.0128515968,
            -0.0215193778,
            0.0627601296,
            -0.0105388267,
            -0.00176997867,
            -0.00197970751,
            -0.00500930706,
            -0.0650941,
            0.0613806471,
            0.0454011038,
            -0.0367995054,
            0.0254899245,
            -0.00583983772,
            0.00903533213,
            0.00207727519,
            -0.0018631696,
            -0.0257387105,
            -8.93747256e-06,
            -0.0435921066,
            -0.00370068103,
            -0.0378787629,
            -0.0115654469,
            0.0206418559,
            -0.0453982428,
            0.0245041549,
            0.0110470811,
            -0.0867036954,
            -0.0722414479,
            0.0574327111,
            -0.00132589694,
            -0.0529463328,
            0.00740903057,
            -0.0325731486,
            -0.0387065969,
            -0.00456783501,
            0.0119009754,
            0.0113206487,
            -0.0196294896,
            0.0275213849,
            -0.0238809735,
            0.0401004292,
            0.0215645675,
            0.0821288,
            -0.0590155385,
            0.0203290842,
            -0.022537211,
            0.0667063221,
            0.0153941987,
            -0.04629,
            -0.0335654691,
            0.0447608046,
            0.0712818205,
            -0.0447032414,
            0.0586036108,
            0.0127337044,
            0.0686368421,
            -0.0445186235,
            0.0171661135,
            -0.0463912748,
            0.00176657713,
            0.00637342408,
            0.0614207,
            -0.0513381325,
            -0.00247286609,
            -0.0564249307,
            0.053444352,
            0.0489679761,
            0.0136508606,
            0.0260351021,
            -0.0617160536,
            0.0195695125,
            -0.0457462817,
            0.000922039966,
            -0.00661739567,
            -0.00739813363,
            0.00758943288,
            -0.0096120676,
            0.023284385,
            -0.0532461628,
            0.055555366,
            -0.0587420054,
            -0.0145982988,
            -0.00814454444,
            -0.029041443,
            0.0376620889,
            -0.0252300631,
            -0.0311177671,
            -0.0433343202,
            -0.0801744312,
            0.0051286188,
            -0.0117812147,
            0.00341733126,
            0.00938781351,
            0.011777685,
            0.0148335975,
            -0.0277195629,
            0.0123453718,
            0.0278702546,
            0.0875230283,
            -0.00270297402,
            -0.063076973,
            0.0188422855,
            -0.00403491175,
            -0.0471702963,
            0.0234453846,
            0.0590430163,
            -0.0108596943,
            0.0254774466,
            0.014228195,
            0.0399711616,
            -0.0331944451,
            0.0511033162,
            0.00181544444,
            -0.051350791,
            -0.047171291,
            0.046385847,
            -0.0758504793,
            -0.0359233804,
            -0.0527860299,
            -0.0310829934,
            0.0273997113,
            -0.013026597,
            -0.0111188106,
            0.0608597398,
            -0.0482321046,
            -0.0258922912,
            0.00169993087,
            0.027998073,
            -0.0176431239,
            -0.0488402918,
            0.00537787285,
            -0.0303735491,
            0.0532670096,
            -0.0747735798,
            -0.0522974,
            0.0408295728,
            -0.0339402668,
            0.0782882422,
            -0.0616549887,
            -0.0164784435,
            -0.000418972195,
            -0.0615269542,
            -0.0652060732,
            0.0168461986,
            0.023779789,
            -0.00830957666,
            0.0322482362,
            0.0101234391,
            0.0183810554,
            0.0611572,
            -0.0576220863,
            0.0585969687,
            0.0524734035,
            0.0155905252,
            -0.0114955697,
            0.0389203243,
            -0.0816540048,
            0.0333792344,
            -3.59820151e-05,
            -0.0825404,
            -0.0120201958,
            0.0542859435,
            0.0610220581,
            -0.0354424678,
            -0.0552756786,
            -0.0295781717,
            0.0185690299,
            0.00150327024,
            0.0721035451,
            0.0565820262,
            -0.0462506041,
            0.0599502213,
            0.0270324554,
            0.0560304299,
            0.0083307,
            0.030570576,
            0.0126786949,
            -0.0757859871,
            0.0523104481,
            0.0342875086,
            -0.0569878705,
            0.0545989498,
            -0.00326171727,
            0.060357891,
            0.0450131707,
            -0.0370508507,
            0.0494463779,
            0.0372443758,
            0.0386247933,
            0.0269798301,
            -0.0416742489,
            -0.041031681,
            -0.0551407784,
            0.0245419107,
            -0.0880111083,
            0.0564557835,
            -0.0197226629,
            -0.00508610113,
            0.0288533475,
            0.0506108254,
            0.0622704849,
            0.0195873361,
            0.0571832731,
            -0.0515637,
            -0.0525595956,
            0.054129988,
            0.048440028,
            0.0269622579,
            -0.0691432133,
            0.0849805102,
            0.00782544632,
            0.0413544104,
            0.0307717454,
            -0.0481993072,
            0.0192321576,
            -0.0136067318,
            0.0483239964,
            0.0390462,
            0.0193251055,
            0.0841494575,
            -0.00714757154,
            0.0205039065,
            -0.0234797522,
            -0.0531298779,
            0.0762817711,
            -0.0748820379,
            0.0725904852,
            -0.0129225245,
            0.00805024058,
            0.083000578,
            0.0311288051,
            0.05821722,
            0.0536931865,
            0.0153830424,
            -0.0278128516,
            -0.0220776536,
            0.0599335767,
            -0.0702146888,
            -0.0734173954,
            0.0581872091,
            0.0122636687,
            0.0575926937,
            -0.0149118677,
            0.00734939193,
            0.00408879342,
            -0.0258262325,
            0.0290717203,
            0.00432063639,
            0.0420119204,
            0.0648235381,
            -0.0368639082,
            -0.088551119,
            0.025492562,
            -0.00671357708,
            -0.00151624018,
            -0.00575079583,
            -0.0513045,
            -0.0650696233,
            -0.0282735489,
            0.0594246127,
            -0.0133492518,
            -0.0520944595,
            0.0885598138,
            -0.0388713591,
            -0.028774688,
            -0.0534844287,
            -0.0433065481,
            0.0731182098,
            -0.00558777712,
            0.00864775293,
            0.0220839884,
            0.00449009752,
            0.06726221,
            -0.0477219149,
            0.0587590039,
            0.0331693813,
            -0.0452298187,
            -0.0853359327,
            -0.0571915284,
            -0.0276267342,
            -0.0316127911,
            -0.0380848944,
            0.0618811511,
            -0.0688346773,
            -0.0414689928,
            0.033760298,
            0.0555542596,
            -0.0578569472,
            0.0503363572,
            -0.0484394841,
            -0.0232159123,
            0.0312915407,
            -0.0681264251,
            -0.00314639439,
            0.0716677,
            0.0160381272,
            0.0633105114,
            -0.00784463249,
            -0.0655638278,
            -0.00852004,
            0.0299258,
            0.00100595702,
            0.0266825892,
            0.0337195098,
            -0.0624647848,
            0.0428469814,
            0.0347290114,
            -0.00744933868,
            0.0380470231,
            0.0644883588,
            0.00663479371,
            -0.0362436,
            -0.0643614605,
            -0.0207556318,
            0.0397171117,
            0.0183968749,
            -0.0306244027,
            -0.00465779891,
            0.0193711407,
            0.048199594,
            -0.00257707736,
            0.0139806569,
            0.0193464495,
            -0.0882179141,
            0.0170989688,
            0.00747032,
            -0.0681559294,
            0.00199876353,
            -0.0170962829,
            -0.0264179613,
            0.0341433585,
            0.0197609812,
            -0.0867511407,
            0.0749756172,
            0.0275120046,
            0.0622667186,
            0.074995406,
            0.0320236944,
            -0.0802299231,
            -0.0121256318,
            -0.00536344387,
            0.0666391328,
            0.00177087646,
            0.008687458,
            -0.0510008782,
            0.0403936803,
            0.0128359888,
            0.0436886959,
            -0.0470289551,
            -0.0131758265,
            -0.0286239516,
            -0.00435533,
            0.0699352846,
            0.0739938542,
            -0.0471784137,
            -0.0122550894,
            0.0731498227,
            -0.0496871807,
            -0.028823588,
            -0.0178634,
            0.030468097,
            -0.0224756449,
            -0.036595609,
            -0.00598966889,
            -0.045963,
            0.0703515708,
            0.0903150067,
            0.0116407685,
            0.0879645944,
            -0.0150299659,
            0.0367615521,
            -0.0636311322,
            -0.0709881559,
            0.0423413329,
            0.0604740828,
            -0.075571835,
            -0.0326083489,
            -0.0102705294,
            -0.0313403532,
            0.0660994351,
            -0.00681410125,
            0.0194644928,
            0.0493939742,
            -0.0442177691,
            -0.00949192327,
            0.0183788799,
            0.0402500629,
            -0.0553275533,
            -0.0822996423,
            -0.0122121517,
            0.0667236894,
            0.0325955972,
            -0.0808690488,
            0.0811742395,
            0.0148495696,
            -0.0109562455,
            0.0163367912,
            0.026753,
            -0.0111638429,
            -0.0179125313,
            -0.0481426567,
            -0.0900867805,
            -0.00970309228,
            0.0102302795,
            -0.0614523329,
            0.00588896777,
            -0.0576899387,
            -0.0538066179,
            0.00498126773,
            0.0338703506,
            0.0637848,
            0.0429722406,
            -0.0164462477,
            0.0616709627,
            0.0680689737,
            0.0104377894,
            0.0457579978,
            0.0681705847,
            -0.0352334715,
            -0.0162582714,
            -0.0287922323,
            0.00643704692,
            -0.065342024,
            0.0253852364,
            0.0359382443,
            -0.0633043498,
            -0.0781773329,
            0.0437798239,
            0.045608528,
            0.0743300095,
            0.00234405673,
            -0.00127170503,
            -0.0444713607,
            -0.0442832224,
            0.0570710078,
            0.0163942724,
            -0.0186840836,
            -0.0485453345,
            -0.0646353588,
            -0.0298207924,
            -0.0203709435,
            -0.0342230834,
            -0.0614796802,
            -0.0298118964,
            -0.047947444,
            0.0707997903,
            0.000571856508,
            0.0795319378,
            -0.00514993304,
            -0.00273825694,
            -0.0371305607,
            0.0429580621,
            -0.0317286216,
            0.0721056387,
            -0.031359043,
            0.0904549882,
            0.000538855908,
            -0.0425510816,
            0.00102679839,
            0.0138213672,
            0.0219727363,
            0.0429495536,
            -0.0302602462,
            0.0283694603,
            0.0548484735,
            -0.0057882932,
            0.0166589469,
            -0.0292618163,
            -0.0261669941,
            0.00209843274,
            -0.0795575157,
            0.0623760074,
            0.068322,
            -0.0525659285,
            0.060027767,
            -0.065812543,
            0.080318734,
            0.0474538021,
            -0.0372884795,
            0.00209921482,
            0.0159174539,
            -0.0719953403,
            -0.0155042121,
            -0.0358802825,
            -0.0183925014,
            0.0385716707,
            0.0150135467,
            -0.0773999169,
            0.0246565901,
            0.0234719645,
            -0.00483173504,
            -0.0802785158,
            -0.0172311347,
            -0.0195393767,
            -0.0505290031,
            0.0574247502,
            -0.0176026393,
            0.0077144145,
            -0.000514608226,
            0.030548431,
            -0.00176994328,
            0.0488331057,
            0.0125436336,
            -0.0139672887,
            -0.0763528347,
            0.0467454977,
            -0.0820599869,
            0.0718975291,
            0.0271646883,
            -0.0719457641,
            -0.00553008169
        ]
    ]
}
```






